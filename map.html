<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Active Warnings Map</title>
    <link
      rel="icon"
      type="image/x-icon"
      href="https://cdn.glitch.global/10289291-dda7-497d-a43c-f017e0457b15/image_2023-12-16_172444899.png?v=1739490392300"
    />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        padding: 20px;
        background-color: #ffffff;
        color: #000000;
        transition: background-color 0.3s, color 0.3s;
      }
      body.dark {
        background-color: #1c1c1c;
        color: #ffffff;
      }
      .map-container {
        width: 100%;
        height: 650px;
        margin-top: 20px;
        filter: brightness(1);
      }
      button {
        margin: 10px;
        padding: 10px;
      }
      @keyframes pulse {
        0% {
          stroke-width: 2px;
        }
        50% {
          stroke-width: 6px;
        }
        100% {
          stroke-width: 2px;
        }
      }

      .emergency {
        animation: pulse 1.5s infinite;
        stroke: #ff69b4 !important;
      }

      .destructive {
        animation: pulse 1s infinite;
        stroke: #ffb833 !important;
      }
    </style>
  </head>
  <body>
    <h1>Active Warnings Map</h1>
    <button onclick="toggleDarkMode()">Toggle Dark Mode</button>
    <a href="index.html"><button>Home</button></a>
    <div id="map" class="map-container"></div>
    <script>
      let map = L.map("map").setView([39.8283, -98.5795], 4);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap contributors",
      }).addTo(map);

      let radarLayer = L.tileLayer
        .wms("https://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0q.cgi?", {
          layers: "nexrad-n0q-900913",
          format: "image/png",
          transparent: true,
          attribution: "Iowa Environmental Mesonet",
        })
        .addTo(map);

      function refreshRadarLayer() {
        map.removeLayer(radarLayer);
        radarLayer = L.tileLayer
          .wms(
            "https://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0q.cgi?",
            {
              layers: "nexrad-n0q-900913",
              format: "image/png",
              transparent: true,
              attribution: "Iowa Environmental Mesonet",
            }
          )
          .addTo(map);
      }
      let lastUpdateTime = null;

      async function conditionalRefreshRadarLayer() {
        const response = await fetch(
          "https://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0q.cgi?"
        );
        const currentUpdateTime = response.headers.get("Last-Modified");

        if (currentUpdateTime && currentUpdateTime !== lastUpdateTime) {
          lastUpdateTime = currentUpdateTime;
          refreshRadarLayer();
        }
      }

      setInterval(conditionalRefreshRadarLayer, 60000); // Check every 60 seconds

      function toggleDarkMode() {
        document.body.classList.toggle("dark");
      }

      const warningColors = {
        "Tsunami Warning": "#FD6347",
        "Tornado Warning": "#FF0000",
        "Extreme Wind Warning": "#FF8C00",
        "Severe Thunderstorm Warning": "#FFA500",
        "Flash Flood Warning": "#8B0000",
        "Flash Flood Statement": "#8B0000",
        "Severe Weather Statement": "#00FFFF",
        "Shelter In Place Warning": "#FA8072",
        "Evacuation Immediate": "#5FBF00",
        "Civil Danger Warning": "#FFB6C1",
        "Nuclear Power Plant Warning": "#4B0082",
        "Radiological Hazard Warning": "#4B0082",
        "Hazardous Materials Warning": "#4B0082",
        "Fire Warning": "#A0522D",
        "Civil Emergency Message": "#FFB6C1",
        "Law Enforcement Warning": "#C0C0C0",
        "Storm Surge Warning": "#B524F7",
        "Hurricane Force Wind Warning": "#CD5C5C",
        "Hurricane Warning": "#DC143C",
        "Typhoon Warning": "#DC143C",
        "Special Marine Warning": "#FFA500",
        "Blizzard Warning": "#FF4500",
        "Snow Squall Warning": "#C71585",
        "Ice Storm Warning": "#8B008B",
        "Heavy Freezing Spray Warning": "#00BFFF",
        "Winter Storm Warning": "#FF69B4",
        "Lake Effect Snow Warning": "#008B8B",
        "Dust Storm Warning": "#FFE4C4",
        "Blowing Dust Warning": "#FFE4C4",
        "High Wind Warning": "#DAA520",
        "Tropical Storm Warning": "#B22222",
        "Storm Warning": "#9400D3",
        "Tsunami Advisory": "#D2691E",
        "Tsunami Watch": "#FF00FF",
        "Avalanche Warning": "#1E90FF",
        "Earthquake Warning": "#8B4513",
        "Volcano Warning": "#2F4F4F",
        "Ashfall Warning": "#A9A9A9",
        "Flood Warning": "#00FF00",
        "Coastal Flood Warning": "#228B22",
        "Lakeshore Flood Warning": "#228B22",
        "Ashfall Advisory": "#696969",
        "High Surf Warning": "#228B22",
        "Excessive Heat Warning": "#C71585",
        "Tornado Watch": "#FFFF00",
        "Severe Thunderstorm Watch": "#DB7093",
        "Flash Flood Watch": "#2E8B57",
        "Gale Warning": "#DDA0DD",
        "Flood Statement": "#00FF00",
        "Extreme Cold Warning": "#0000FF",
        "Freeze Warning": "#483D8B",
        "Red Flag Warning": "#FF1493",
        "Storm Surge Watch": "#DB7FF7",
        "Hurricane Watch": "#FF00FF",
        "Hurricane Force Wind Watch": "#9932CC",
        "Typhoon Watch": "#FF00FF",
        "Tropical Storm Watch": "#F08080",
        "Storm Watch": "#FFE4B5",
        "Tropical Cyclone Local Statement": "#FFE4B5",
        "Winter Weather Advisory": "#7B68EE",
        "Avalanche Advisory": "#CD853F",
        "Cold Weather Advisory": "#AFEEEE",
        "Heat Advisory": "#FF7F50",
        "Flood Advisory": "#00FF7F",
        "Coastal Flood Advisory": "#7CFC00",
        "Lakeshore Flood Advisory": "#7CFC00",
        "High Surf Advisory": "#BA55D3",
        "Dense Fog Advisory": "#708090",
        "Dense Smoke Advisory": "#F0E68C",
        "Small Craft Advisory": "#D8BFD8",
        "Brisk Wind Advisory": "#D8BFD8",
        "Hazardous Seas Warning": "#D8BFD8",
        "Dust Advisory": "#BDB76B",
        "Blowing Dust Advisory": "#BDB76B",
        "Lake Wind Advisory": "#D2B48C",
        "Wind Advisory": "#D2B48C",
        "Frost Advisory": "#6495ED",
        "Freezing Fog Advisory": "#008080",
        "Freezing Spray Advisory": "#00BFFF",
        "Low Water Advisory": "#A52A2A",
        "Local Area Emergency": "#C0C0C0",
        "Winter Storm Watch": "#4682B4",
        "Rip Current Statement": "#40E0D0",
        "Beach Hazards Statement": "#40E0D0",
        "Gale Watch": "#FFC0CB",
        "Avalanche Watch": "#F4A460",
        "Hazardous Seas Watch": "#483D8B",
        "Heavy Freezing Spray Watch": "#BC8F8F",
        "Flood Watch": "#2E8B57",
        "Coastal Flood Watch": "#66CDAA",
        "Lakeshore Flood Watch": "#66CDAA",
        "High Wind Watch": "#B8860B",
        "Excessive Heat Watch": "#800000",
        "Extreme Cold Watch": "#5F9EA0",
        "Freeze Watch": "#00FFFF",
        "Fire Weather Watch": "#FFDEAD",
        "Extreme Fire Danger": "#E9967A",
        "911 Telephone Outage": "#C0C0C0",
        "Coastal Flood Statement": "#6B8E23",
        "Lakeshore Flood Statement": "#6B8E23",
        "Special Weather Statement": "#FFE4B5",
        "Marine Weather Statement": "#FFDAB9",
        "Air Quality Alert": "#808080",
        "Air Stagnation Advisory": "#808080",
        "Hazardous Weather Outlook": "#EEE8AA",
        "Hydrologic Outlook": "#90EE90",
        "Short Term Forecast": "#98FB98",
        "Administrative Message": "#C0C0C0",
        Default: "#000000", // Default to black if no match
      };

      async function fetchWarnings() {
        try {
          const response = await fetch("https://api.weather.gov/alerts/active");
          const data = await response.json();

          const now = new Date();
          const uniqueWarnings = {};

          const validWarnings = data.features.filter((warning) => {
            const expires = new Date(warning.properties.expires);
            const id = warning.id;
            if (expires > now && !uniqueWarnings[id]) {
              uniqueWarnings[id] = true;
              return true;
            }
            return false;
          });

          const emergencyWarnings = [];
          const destructiveWarnings = [];
          const regularWarnings = [];

          validWarnings.forEach((warning) => {
            if (
              warning.properties.description.includes(
                "FLASH FLOOD EMERGENCY"
              ) ||
              warning.properties.description.includes("TORNADO EMERGENCY")
            ) {
              emergencyWarnings.push(warning);
            } else if (
              warning.properties.description.includes("DESTRUCTIVE STORMS") ||
              warning.properties.description.includes("DESTRUCTIVE STORM")
            ) {
              destructiveWarnings.push(warning);
            } else {
              regularWarnings.push(warning);
            }
          });

          const sortedWarnings = [
            ...regularWarnings.sort(
              (a, b) =>
                new Date(a.properties.sent) - new Date(b.properties.sent)
            ),
            ...destructiveWarnings,
            ...emergencyWarnings,
          ];

          displayWarningsOnMap(
            sortedWarnings,
            emergencyWarnings,
            destructiveWarnings
          );
        } catch (error) {
          console.error("Error fetching warnings:", error);
        }
      }

      function displayWarningsOnMap(
        warnings,
        emergencyWarnings,
        destructiveWarnings
      ) {
        map.eachLayer((layer) => {
          if (layer instanceof L.Polygon) {
            map.removeLayer(layer);
          }
        });

        warnings.forEach((warning) => {
          if (warning.geometry && warning.geometry.type === "Polygon") {
            const coordinates = warning.geometry.coordinates[0].map((coord) => [
              coord[1],
              coord[0],
            ]);

            let color =
              warningColors[warning.properties.event] || warningColors.Default;
            let weight = 4;
            let className = "";

            if (emergencyWarnings.includes(warning)) {
              color = "#FF69B4"; // Color for emergency warnings
              weight = 6;
              className = "emergency";
            } else if (destructiveWarnings.includes(warning)) {
              color = "#AB7800"; // Color for destructive warnings
              weight = 6;
              className = "destructive";
            }

            const expires = new Date(warning.properties.expires);
            function getTimeRemaining() {
              const now = new Date();
              const timeLeft = expires - now;
              if (timeLeft <= 0) return "Expired";
              const minutes = Math.floor((timeLeft / 1000 / 60) % 60);
              const hours = Math.floor(timeLeft / 1000 / 60 / 60);
              return `${hours}h ${minutes}m`;
            }

            const polygon = L.polygon(coordinates, {
              color: color,
              weight: weight,
              opacity: 1,
              fillOpacity: 0.45,
              className: className,
            })
              .bindPopup(
                () => `
            <strong>Event:</strong> ${warning.properties.event}<br>
            <strong>Sender:</strong> ${
              warning.properties.senderName || "N/A"
            }<br>
            <strong>Area(s):</strong> ${
              warning.properties.areaDesc || "N/A"
            }<br>
            <strong>Sent:</strong> ${new Date(
              warning.properties.sent
            ).toLocaleString()}<br>
            <strong>Expires:</strong> ${new Date(
              warning.properties.expires
            ).toLocaleString()}<br>
            <strong>Time Remaining:</strong> ${getTimeRemaining()}<br>
          `
              )
              .addTo(map);

            if (
              emergencyWarnings.includes(warning) ||
              destructiveWarnings.includes(warning)
            ) {
              polygon.bringToFront();
            }
          }
        });
      }

      fetchWarnings();
      setInterval(fetchWarnings, 10000);
    </script>
  </body>
</html>
